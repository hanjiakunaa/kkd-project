# 分片上传 Mock 接口使用说明

## 📝 概述

为了方便在没有后端接口的情况下测试分片上传功能，我们在 `src/api/shard-upload.js` 中实现了完整的 Mock 功能。

## 🔧 配置

### 开启/关闭 Mock 模式

在 `src/api/shard-upload.js` 文件的第 4 行：

```javascript
// 开启 Mock 模式（调试时设置为 true）
const USE_MOCK = true
```

- `USE_MOCK = true`：使用 Mock 数据，无需后端接口
- `USE_MOCK = false`：使用真实后端接口

## ✨ Mock 功能特性

### 1. **完整的上传流程模拟**

- ✅ 文件切片上传
- ✅ 网络延迟模拟（100-400ms）
- ✅ 随机失败模拟（5% 概率，用于测试重试机制）
- ✅ 上传取消支持

### 2. **秒传功能模拟**

- 当同一个文件第二次上传时，会自动识别并启用秒传
- Mock 会记录已完成上传的文件，再次上传时直接返回成功

### 3. **断点续传功能模拟**

- 支持暂停和恢复上传
- Mock 会记录已上传的切片
- 恢复上传时会跳过已上传的切片

### 4. **文件合并模拟**

- 模拟服务器合并切片的过程（500ms 延迟）
- 返回模拟的文件地址

## 🎮 页面调试工具

在分片上传页面的右上角，我们提供了两个调试按钮：

### 1. **清空Mock数据**

- 清空所有已上传的文件和切片记录
- 用于测试秒传和断点续传功能
- 点击后可以重新上传相同的文件

### 2. **清空任务列表**

- 清空页面上的所有上传任务
- 重置全局进度统计
- 用于清空界面，重新开始测试

## 📊 控制台日志

Mock 模式会在控制台输出详细的日志信息：

```bash
[Mock] 文件 test.pdf 检查完成，已上传切片数: 0
[Mock] 切片 0 上传成功 (test.pdf)
[Mock] 切片 1 上传成功 (test.pdf)
...
[Mock] 文件 test.pdf 合并成功
[Mock] 已清空所有 Mock 数据
```

## 🧪 测试场景

### 场景 1：正常上传

1. 选择一个文件
2. 观察切片上传进度
3. 等待文件上传完成

### 场景 2：测试秒传

1. 上传一个文件，等待完成
2. 不要清空 Mock 数据
3. 再次选择相同的文件
4. 观察控制台，应该看到"启用秒传"的日志
5. 文件会立即标记为完成

### 场景 3：测试断点续传

1. 上传一个较大的文件
2. 在上传过程中点击"暂停"按钮
3. 等待几秒后点击"恢复"按钮
4. 观察上传会从断点处继续

### 场景 4：测试失败重试

1. 上传文件时观察控制台
2. 可能会看到"模拟网络错误"的日志
3. 系统会自动重试失败的切片
4. 最多重试 3 次

### 场景 5：测试多文件上传

1. 同时选择多个文件
2. 观察并发上传的效果
3. 可以调整"并发数"参数（1-12）

## 🔍 Mock 数据结构

Mock 数据存储在内存中：

```javascript
const mockState = {
  uploadedChunks: new Map([
    ['fileHash1', new Set(['chunkHash1', 'chunkHash2'])],
    ['fileHash2', new Set(['chunkHash3', 'chunkHash4'])],
  ]),
  uploadedFiles: new Set(['fileHash1', 'fileHash2']),
}
```

## ⚙️ 参数调整

### 切片大小（1-16 MB）

- 较小的切片：更细粒度的进度，但请求数多
- 较大的切片：请求数少，但进度更新不够细致
- 建议：1-5 MB

### 并发数（1-12）

- 较小的并发：上传速度慢，但稳定
- 较大的并发：上传速度快，但可能占用更多资源
- 建议：6-8

## 🚀 切换到真实接口

当后端接口准备好后，只需要：

1. 修改 `src/api/shard-upload.js` 第 4 行：

   ```javascript
   const USE_MOCK = false
   ```

2. 确保后端接口路径正确：

   - POST `/api/checkFile` - 文件检查
   - POST `/api/uploadChunk` - 切片上传
   - POST `/api/mergeChunk` - 切片合并

3. 后端接口响应格式：
   ```javascript
const response = {
  code: 0,      // 0 表示成功，非 0 表示失败
  data: {},     // 返回数据
  message: '',  // 提示信息
}
   ```

## 📝 注意事项

1. **Mock 数据仅存在于内存中**

   - 刷新页面会丢失所有 Mock 数据
   - 秒传和断点续传的记录会被清空

2. **Mock 模式下的随机失败**

   - 有 5% 的概率会模拟网络错误
   - 这是为了测试重试机制
   - 如果不想要随机失败，可以注释掉相关代码

3. **性能考虑**
   - Mock 模式下没有真实的文件传输
   - 上传速度取决于模拟的延迟时间
   - 实际使用时速度会受网络影响

## 🎯 调试技巧

1. **打开浏览器控制台**

   - 可以看到详细的 Mock 日志
   - 了解每个切片的上传状态

2. **使用 Vue DevTools**

   - 观察 `fileTasks` 响应式数据的变化
   - 查看每个文件和切片的状态

3. **调整切片大小和并发数**
   - 测试不同配置下的表现
   - 找到最优的参数组合

## 🐛 常见问题

### Q: 为什么上传很快就完成了？

A: Mock 模式下没有真实的文件传输，只是模拟延迟。真实上传速度取决于网络和文件大小。

### Q: 如何测试秒传功能？

A: 上传一个文件完成后，不要点击"清空Mock数据"，直接再次上传相同的文件即可。

### Q: 断点续传是如何工作的？

A: Mock 会记录每个已上传的切片，暂停后恢复时会跳过这些切片。

### Q: 可以关闭随机失败吗？

A: 可以，在 `mockUploadChunk` 函数中注释掉模拟失败的代码（71-75行）。

---

**开发者**: 此 Mock 系统完全模拟了真实的分片上传流程，可以放心用于开发和测试！🎉
